name: Deploy EC2 with Terraform

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
    - uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.6

    - name: Check Terraform
      run: terraform -version

    - name: Terraform Init
      run: terraform -chdir=infrastructure init

    - name: Terraform Apply
      run: terraform -chdir=infrastructure apply -auto-approve

    - name: Capture EC2 IP
      id: tfout
      run: |
        ip=$(terraform -chdir=infrastructure output -raw ec2_public_ip | tr -d '\n')
        echo "EC2_IP=$ip" >> $GITHUB_OUTPUT

    - name: Log EC2 IP
      env:
        EC2_IP: ${{ steps.tfout.outputs.EC2_IP }}
      run: |
        echo "Provisioned EC2 IP: $EC2_IP"

    outputs:
      EC2_IP: ${{ steps.tfout.outputs.EC2_IP }}

  deploy:
    needs: terraform
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup SSH
      env:
        EC2_IP: ${{ needs.terraform.outputs.EC2_IP }}
        SSH_KEY: ${{ secrets.SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "$EC2_IP" >> ~/.ssh/known_hosts

    - name: Upload web app
      env:
        EC2_IP: ${{ needs.terraform.outputs.EC2_IP }}
      run: scp -o StrictHostKeyChecking=no -r web-app/* ec2-user@$EC2_IP:/var/www/html/

    - name: Restart Apache
      env:
        EC2_IP: ${{ needs.terraform.outputs.EC2_IP }}
      run: ssh -o StrictHostKeyChecking=no ec2-user@$EC2_IP "sudo systemctl restart httpd"

    - name: Health Check
      env:
        EC2_IP: ${{ needs.terraform.outputs.EC2_IP }}
      run: curl -I http://$EC2_IP