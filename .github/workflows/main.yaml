name: Deploy Feedback Web App

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init & Apply
        run: |
          terraform -chdir=infrastructure init
          terraform -chdir=infrastructure apply -auto-approve

      - name: Capture Terraform outputs
        run: |
          EC2_IP=$(terraform -chdir=infrastructure output -raw ec2_public_ip)
          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV

      - name: Write SSH key
        run: |
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ssh.key
          chmod 600 ssh.key

      - name: Upload feedback app
        run: |
          scp -o StrictHostKeyChecking=no -i ssh.key web-app/index.html ec2-user@${EC2_IP}:/tmp/index.html
          ssh -o StrictHostKeyChecking=no -i ssh.key ec2-user@${EC2_IP} "sudo mv /tmp/index.html /var/www/html/index.html && sudo systemctl restart httpd"